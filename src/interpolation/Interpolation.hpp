//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//														//
//		Written by: Vicente José Bevia Escrig			//
//		Mathematics Ph.D. student (2020-2024) at:		//
//		Instituto de Matemática Multidisciplinar,		//
//		Universitat Politècnica de València, Spain		//
//														//
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////
#ifndef __INTERPOLATION_HPP__
#define __INTERPOLATION_HPP__

#include "CSRBF.hpp"

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class InterpHandle {
	// Attributes
public:
	deviceUniquePtr<floatType> GPU_R;
	deviceUniquePtr<floatType> GPU_temp;
	deviceUniquePtr<floatType> GPU_AP;
	deviceUniquePtr<floatType> GPU_P;

public:
	// Constructor
	hostFunction InterpHandle(uintType size = 1);

	// Methods	
	void resize(uintType size = 1);

};

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


__global__ void UPDATE_VEC(
	floatType* x, const floatType* x0, const floatType scalar, const floatType* v, const intType Max_Length);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


__global__ void MATRIX_VECTOR_MULTIPLICATION(
	floatType* X, const floatType* x0, const intType* Matrix_idxs, const floatType* Matrix_entries, const intType total_length, const intType Max_Neighbors);


hostFunction intType CONJUGATE_GRADIENT_SOLVE(deviceUniquePtr<floatType>& GPU_lambdas,
	deviceUniquePtr<intType>& GPU_Index_array,
	deviceUniquePtr<floatType>& GPU_Mat_entries,
	deviceUniquePtr<floatType>& GPU_AdaptPDF,
	InterpHandle& interpVectors,
	const intType					Total_Particles,
	const intType					MaxNeighborNum,
	const uintType					max_steps,
	const floatType							in_tolerance);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

__global__ void RESTART_GRID_FIND_GN(Particle* Particle_Positions,
	floatType* PDF,
	floatType* lambdas,
	const parameterPair* parameter_mesh,
	const intType* n_Samples,
	const floatType 	 		search_radius,
	const uintType	 		Adapt_Pts,
	const uintType	 		Block_samples,
	const uintType	 		offset,
	const cartesianMesh 	Domain,
	const cartesianMesh	Expanded_Domain);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

__global__ void RESTART_GRID_FIND_GN(Particle* Particle_Positions,
	floatType* PDF,
	floatType* lambdas,
	const Param_vec<PHASE_SPACE_DIMENSIONS>* Impulse_weights,
	const floatType 	search_radius,
	const uintType	Adapt_Pts,
	const uintType	Current_sample,
	const cartesianMesh	Domain,
	const cartesianMesh	Expanded_Domain);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

/// @brief This function makes sure that the PDF does not have any negative values! (Having this enforced by the interpolation would've been wonderful)
/// @param PDF 
/// @param Grid_Nodes 
/// @return 

__global__ void CORRECTION(floatType* PDF, const intType Grid_Nodes);

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

#endif